<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Punto de Venta - Calzados Morales</title>
    
    <link rel="stylesheet" href="/assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="/assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        .info-badge { font-size: 1rem; padding: 8px 15px; border-radius: 8px; margin-right: 15px; margin-bottom: 10px; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .badge-talla { background-color: #e9ecef; color: #495057; border: 1px solid #ced4da; }
        .badge-color { background-color: #f8f9fa; color: #333; border: 1px solid #ced4da; }
        .badge-precio { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; font-weight: bold; }
        .info-container { margin-top: 20px; padding: 15px; background-color: #fff; border-radius: 10px; min-height: 40px; }
        .invalid-feedback { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-scroller">
        <nav th:replace="~{fragmentos/navbar :: navbar}"></nav>
        <div class="container-fluid page-body-wrapper">
            <nav th:replace="~{fragmentos/sidebar :: sidebar}"></nav>
            <div class="main-panel">
                <div class="content-wrapper">
                    <div class="page-header">
                        <h3 class="page-title">
                            <span class="page-title-icon bg-gradient-success text-white me-2"><i class="mdi mdi-cart"></i></span> Nueva Venta
                        </h3>
                    </div>
                    <div class="row">
                        <div class="col-md-5 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title text-primary"><i class="mdi mdi-magnify"></i> Seleccionar Producto</h4>
                                    <form th:action="@{/ventas/agregar}" method="post" id="formAgregar">
                                        <div class="form-group">
                                            <label class="fw-bold">Buscar Calzado:</label>
                                            <select class="form-select select2" name="id_producto" id="selectProducto" required onchange="mostrarInfoProducto()">
                                                <option value="" selected>-- Buscar por nombre --</option>
                                                <option th:each="p : ${productos}" th:value="${p.id_producto}" th:text="${p.nombre}"
                                                        th:data-talla="${p.talla.nombre}" th:data-color="${p.color.nombre}" 
                                                        th:data-precio="${p.precio}" th:data-stock="${p.stock}"></option>
                                            </select>
                                        </div>
                                        <div id="infoProducto" class="info-container" style="display:none;">
                                            <span class="info-badge badge-talla"><i class="mdi mdi-ruler"></i> Talla: <b id="lblTalla"></b></span>
                                            <span class="info-badge badge-color"><i class="mdi mdi-palette"></i> Color: <b id="lblColor"></b></span>
                                            <span class="info-badge badge-precio"><i class="mdi mdi-cash"></i> S/ <b id="lblPrecio"></b></span>
                                            <div class="mt-3 text-muted"><i class="mdi mdi-package-variant"></i> Stock: <b id="lblStock" class="text-dark"></b></div>
                                        </div>
                                        <div class="form-group mt-4">
                                            <label class="fw-bold">Cantidad:</label>
                                            <input type="number" name="cantidad" id="txtCantidad" class="form-control form-control-lg text-center" value="1" min="1" required>
                                        </div>
                                        <button type="submit" class="btn btn-gradient-primary w-100 mt-3 btn-lg">AGREGAR</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-7 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body d-flex flex-column">
                                    <h4 class="card-title text-success"><i class="mdi mdi-cart-outline"></i> Carrito</h4>
                                    <div class="table-responsive flex-grow-1">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr><th>Producto</th><th>Cant.</th><th>Subtotal</th><th></th></tr>
                                            </thead>
                                            <tbody>
                                                <tr th:if="${carrito == null or carrito.empty}"><td colspan="4" class="text-center">Carrito vacío</td></tr>
                                                <tr th:each="item, stat : ${carrito}">
                                                    <td th:text="${item.producto.nombre}"></td>
                                                    <td class="text-center" th:text="${item.cantidad}"></td>
                                                    <td class="text-end fw-bold" th:text="'S/ ' + ${item.subtotal}"></td>
                                                    <td><a th:href="@{/ventas/quitar/{index}(index=${stat.index})}" class="text-danger"><i class="mdi mdi-delete"></i></a></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between p-3 bg-light rounded">
                                        <h4>Total:</h4><h2 class="text-success fw-bold" th:text="'S/ ' + ${total}"></h2>
                                    </div>
                                    <hr>
                                    <form th:action="@{/ventas/guardar}" method="post" id="formVenta" target="_blank">
                                        <div class="form-group mb-3">
                                            <label class="fw-bold">Cliente:</label>
                                            <select class="form-select select2" name="id_cliente" id="cboCliente" required>
                                                <option value="">-- Seleccione Cliente --</option>
                                                <option th:each="c : ${clientes}" th:value="${c.id_cliente}" 
                                                        th:text="${c instanceof T(com.calzadosmorales.entity.PersonaNatural) ? 'DNI: ' + c.dni + ' - ' + c.nombre : 'RUC: ' + c.ruc + ' - ' + c.razonSocial}"></option>
                                            </select>
                                        </div>
                                        <div class="d-grid">
                                            <button type="button" onclick="confirmarVenta()" class="btn btn-success btn-lg" th:disabled="${carrito == null or carrito.empty}">
                                                <i class="mdi mdi-printer"></i> GENERAR COMPROBANTE
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script th:inline="javascript">
        $(document).ready(function() { $('.select2').select2({ theme: 'bootstrap-5', width: '100%' }); });

        function mostrarInfoProducto() {
            var option = document.getElementById('selectProducto').options[document.getElementById('selectProducto').selectedIndex];
            if (option.value) {
                document.getElementById('lblTalla').innerText = option.getAttribute('data-talla');
                document.getElementById('lblColor').innerText = option.getAttribute('data-color');
                document.getElementById('lblPrecio').innerText = option.getAttribute('data-precio');
                document.getElementById('lblStock').innerText = option.getAttribute('data-stock');
                $('#infoProducto').fadeIn();
            } else { $('#infoProducto').hide(); }
        }

        function confirmarVenta() {
            var idCli = $('#cboCliente').val();
            if (!idCli) {
                Swal.fire('Atención', 'Seleccione un cliente primero', 'warning');
                return;
            }
            Swal.fire({
                title: '¿Confirmar Venta?',
                text: "Se generará el PDF en otra pestaña.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, Facturar',
                confirmButtonColor: '#198754'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('formVenta').submit();
                    Swal.fire({ icon: 'success', title: 'Venta Registrada', showConfirmButton: false, timer: 2000 });
                    setTimeout(function() { window.location.href = "/ventas/nueva"; }, 2500);
                }
            });
        }
    </script>
</body>
</html>